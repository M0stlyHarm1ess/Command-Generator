<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* 主色调 - 浅蓝色 */
            --primary-color: #60a5fa;
            --primary-hover: #3b82f6;
            --primary-light: #93c5fd;
            /* 侧边栏深灰蓝色 */
            --sidebar-color: #3b4c62;
            --sidebar-hover: #2a3a4d;
            /* 辅助色 */
            --success-color: #34d399;
            --error-color: #f87171;
            --error-color-hover: #ef4444;
            --warning-color: #fbbf24;
            /* 中性色 */
            --bg-color: #f8fafc;
            --surface-color: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            /* 阴影 */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            /* 圆角 */
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            /* 过渡 */
            --transition: all 0.2s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* 主容器 */
        .container {
            display: flex;
            height: 90vh;
            background-color: var(--surface-color);
            max-width: 1600px;
            margin: 5vh auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 10px 20px rgba(0, 0, 0, 0.1);
            border-radius: 24px;
            overflow: hidden;
            transform: translateY(-2px);
        }

        /* 左侧Tab栏 */
        .tab-sidebar {
            width: 220px;
            background: var(--sidebar-color);
            color: white;
            display: flex;
            flex-direction: column;
        }

        /* 标题卡片 - 现代化命令行LOGO设计 */
        .tab-header {
            padding: 1.5rem 1rem;
            background: var(--sidebar-hover);
            color: #10b981;
            font-size: 1.4rem;
            font-weight: 700;
            text-align: center;
            margin: 0;
            
            /* 使用更具命令行风格的字体 */
            font-family: 'Courier New', 'Consolas', 'Monaco', 'Andale Mono', 'Ubuntu Mono', monospace;
            
            /* 调整文字效果 - 更暗的颜色匹配 */
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.8);
            
            /* 移除默认before伪元素 */
        }
        
        /* 闪烁下划线光标 - 放在Command后面 */
        .tab-header span.cursor {
            display: inline-block;
            width: 10px;
            height: 2px;
            background-color: #34d399;
            margin-left: 0.2rem;
            vertical-align: bottom;
            animation: blink 1s steps(2, start) infinite;
            position: relative;
            top: -2px;
        }
        
        /* Generator特殊样式 - 增强机械感设计 */
        .tab-header span.generator {
            /* 选择更具未来机械感的字体组合 */
            font-family: 'Orbitron', 'Rajdhani', 'Roboto Mono', 'Courier New', monospace;
            /* 超粗体，增强机械厚重感 */
            font-weight: 900;
            /* 默认就显示发亮状态 */
            color: #e0ffff;
            /* 调整后的机械感文字效果 - 减小光晕 */
            text-shadow: 
                0 0 3px rgba(224, 255, 255, 0.9),
                0 0 6px rgba(224, 255, 255, 0.7),
                0 0 9px rgba(30, 144, 255, 0.5);
            /* 机械设计元素 */
            letter-spacing: 2px; /* 更大的字间距，增强机械感 */
            font-size: 1.8rem; /* 进一步增大字号 */
            text-transform: uppercase;
            /* 移除所有装饰效果，只保留文字 */
            padding: 0;
            border: none;
            outline: none;
            background: none;
            box-shadow: none;
            border-radius: 0;
            /* 基本样式 */
            position: relative;
            display: inline-block;
            /* 增加与command文本的间距 */
            margin-top: 0.2rem;
        }
        
        /* 为Command和Generator之间添加空格 */
        .tab-header span.cursor {
            margin-right: 0.5rem;
        }
        
        /* 移除悬停效果，保持与默认状态完全一致 */
        .tab-header span.generator:hover {
            /* 不添加任何额外效果，完全继承默认样式 */
        }
        
        @keyframes blink {
            to {
                visibility: hidden;
            }
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .tab-header {
                font-size: 1.1rem;
                padding: 1rem 0.5rem;
            }
            
            .tab-header span.cursor {
                height: 1.3rem;
            }
            
            .tab-header span.generator {
                font-size: 1.5rem;
                letter-spacing: 1.5px;
            }
        }
        
        /* 极小屏幕适配 */
        @media (max-width: 480px) {
            .tab-header {
                font-size: 0.9rem;
                padding: 0.8rem 0.4rem;
            }
            
            .tab-header span.generator {
                font-size: 1.3rem;
                letter-spacing: 1px;
            }
        }

        /* 左侧Tab栏菜单 */
        .tab-list {
            padding: 1.5rem 0;
        }

        /* 底部Tab栏菜单 */
        .tab-list.bottom {
            margin-top: auto;
            padding: 0 0 1.5rem 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-item {
            padding: 0.875rem 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            display: block;
            background: transparent;
            border: none;
            margin: 0;
            font-weight: 500;
            color: white;
            text-decoration: none;
            border-radius: 0;
            box-shadow: none;
        }

        .tab-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .tab-item.active {
            background: #f8fafc;
            color: var(--text-primary);
            border-radius: 8px 0 0 8px;
            margin: 0 0 0.25rem 1rem;
            box-shadow: none;
            transform: translateY(0);
            border: none;
            outline: none;
            position: relative;
            z-index: 2;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            display: flex;
            background-color: #f8fafc;
            overflow: hidden;
            border-left: none;
            position: relative;
            z-index: 1;
        }

        /* Tab内容区域 */
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
            background-color: #f8fafc;
        }



        .tab-content.active {
            display: flex;
        }

        /* 命令显示区 */
        .commands-section {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background-color: var(--bg-color);
            max-height: 100%;
        }

        /* 右侧变量区 */
        .variables-section {
            width: 320px;
            padding: 2rem;
            background-color: var(--bg-color);
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
            max-height: 100%;
        }

        /* 管理页面样式 */
        .management-page {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background-color: var(--bg-color);
            max-height: 100%;
        }
        
        /* 命令项 */
        .command-item {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            margin-bottom: 1rem;
        }

        .command-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .command-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .command-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .command-actions {
            display: flex;
            gap: 0.75rem;
        }

        .edit-btn, .delete-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .edit-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .delete-btn {
            background-color: var(--error-color);
            color: white;
        }

        .edit-btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .delete-btn:hover {
            background-color: var(--error-color-hover, #e90064);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* 命令描述 */
        .command-description {
            color: var(--text-secondary);
            margin: 0.75rem 0;
            line-height: 1.5;
        }

        /* 代码块 */
        .code-block {
            position: relative;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 1rem;
            overflow-x: auto;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 1rem;
            padding-right: 80px; /* 为复制按钮留出空间 */
        }

        .copy-btn {
            position: absolute;
            top: 50%;
            right: 0.75rem;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .copy-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
            transform: translateY(calc(-50% - 1px));
        }

        .copy-btn.copied {
            background-color: var(--success-color);
            animation: pulse 0.6s ease-in-out;
            transform: translateY(-50%);
        }

        @keyframes pulse {
            0%, 100% {
                transform: translateY(-50%) scale(1);
            }
            50% {
                transform: translateY(-50%) scale(1.05);
            }
        }

        .variables-section h2, .commands-section h2, .management-page h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .management-page h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.25rem;
        }

        /* 变量项 */
        .variable-item {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            margin-bottom: 1rem;
        }

        .variable-item:hover {
            box-shadow: var(--shadow-md);
        }

        .variable-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .variable-value {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .variable-value:hover {
            border-color: var(--primary-color);
            background-color: var(--surface-color);
            box-shadow: var(--shadow-sm);
        }

        .variable-value.editing {
            background-color: var(--surface-color);
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        /* 添加表单 */
        .add-variable-form, .add-command-form {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .add-variable-form:hover, .add-command-form:hover {
            box-shadow: var(--shadow-md);
        }

        /* 输入框样式 */
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: var(--surface-color);
            color: var(--text-primary);
            font-family: inherit;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.5;
        }

        /* 标签样式 - 扁平卡通风格 */
        .tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            border: 2px solid white;
        }

        .tag:hover {
            background: var(--primary-hover);
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* 编辑命令模态框 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: 1rem;
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 600px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .close-btn:hover {
            color: var(--text-primary);
            background-color: var(--bg-color);
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .cancel-btn, .save-btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cancel-btn {
            background-color: var(--bg-color);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .save-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .cancel-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .save-btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Toast 容器样式 */
        .toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 2000;
            height: auto;
        }
        
        /* Toast 提示样式 */
        .toast {
            position: absolute;
            right: 0;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-sm);
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: var(--shadow-md);
            transform: translateX(400px);
            transition: var(--transition);
            background-color: var(--primary-color);
            width: max-content;
            max-width: 300px;
        }
        
        .toast.success {
            background-color: var(--success-color);
        }
        
        .toast.error {
            background-color: var(--error-color);
        }
        
        .toast.warning {
            background-color: var(--warning-color);
            color: var(--text-primary);
        }
        
        /* 表单验证错误样式 */
        .input-error {
            border-color: var(--error-color) !important;
            box-shadow: 0 0 0 3px rgba(247, 37, 133, 0.1) !important;
        }
        
        .error-message {
            color: var(--error-color);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            font-weight: 500;
        }
        
        /* 搜索和筛选区域 */
        #searchInput {
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        #searchInput:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        #tagFilterContainer {
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        #tagFilterContainer:hover {
            border-color: var(--primary-color);
        }
        
        /* 选中标签样式 - 扁平卡通风格 */
        .selected-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.4rem 0.7rem;
            background: var(--primary-color);
            color: white;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            border: 2px solid white;
        }
        
        /* 拖动排序样式 */
        [draggable="true"] {
            cursor: move;
            transition: box-shadow 0.2s ease;
        }
        
        [draggable="true"].dragging {
            opacity: 0.5;
            box-shadow: var(--shadow-lg);
            transform: none;
        }
        
        [draggable="true"]:hover {
            box-shadow: var(--shadow-md);
        }
        
        /* 插入标记样式 */
        .drag-insert-marker {
            height: 4px;
            background-color: var(--primary-color);
            border-radius: 2px;
            margin: 4px 0;
            transition: all 0.2s ease;
        }
        
        .selected-tag:hover {
            background: var(--primary-hover);
        }
        
        .selected-tag span:last-child {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
            font-weight: bold;
        }
        
        .selected-tag span:last-child:hover {
            background-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }
        
        #clearTagsBtn {
            transition: var(--transition);
        }
        
        #clearTagsBtn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* 数据管理区域 */
        .management-page > div {
            margin-bottom: 2rem;
        }

        /* 二级导航内容区域 */
        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        /* 二级导航标签悬停效果 */
        .sub-tab-item:hover {
            color: var(--primary-color) !important;
            background-color: rgba(96, 165, 250, 0.05);
        }

        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .tab-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .tab-list {
                display: flex;
                overflow-x: auto;
                padding: 0;
            }
            
            .tab-item {
                flex-shrink: 0;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            
            .tab-item.active {
                border-left-color: transparent;
                border-bottom-color: var(--primary-light);
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .commands-section {
                padding: 1rem;
            }
            
            .variables-section {
                width: 100%;
                border-left: none;
                border-top: 1px solid var(--border-color);
                padding: 1rem;
            }
            
            .management-page {
                padding: 1rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .toast {
                right: 1rem;
                left: 1rem;
                position: relative !important;
                width: auto !important;
                max-width: none !important;
                transform: translateX(0) !important;
            }
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- 主容器 -->
    <div class="container">
        <!-- 左侧Tab栏 -->
        <div class="tab-sidebar">
            <div class="tab-header">&gt; ./Command<span class="cursor"></span> <span class="generator">Generator</span></div>
            <div class="tab-list">
                <div class="tab-item active" data-tab="main">主页面</div>
                <!-- 分栏菜单项将通过JavaScript动态生成 -->
            </div>
            <div class="tab-list bottom">
                <div class="tab-item" data-tab="management">管理面板</div>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 主页面 - 命令显示 + 变量赋值 -->
            <div class="tab-content active" id="main">
                <!-- 命令显示区 -->
                <div class="commands-section">
                    <h2>命令列表</h2>
                    
                    <!-- 搜索和筛选区域 - 同一行布局 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: flex-start;">
                        <!-- 搜索框 -->
                        <div style="flex: 2;">
                            <label for="searchInput" style="display: block; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">搜索</label>
                            <div style="display: flex;">
                                <input type="text" id="searchInput" placeholder="搜索命令或描述..." style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; min-height: 42px; box-sizing: border-box;">
                            </div>
                        </div>
                        
                        <!-- 标签筛选 - 自定义多选下拉框 -->
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">标签筛选</label>
                            <div style="position: relative; display: flex; gap: 0.5rem; align-items: center;">
                                <!-- 下拉框显示区域 -->
                                <div id="tagFilterContainer" style="border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem; min-height: 42px; cursor: pointer; background-color: var(--surface-color); display: flex; flex-wrap: wrap; gap: 0.3rem; align-items: center; flex: 1; box-sizing: border-box;">
                                    <span id="tagFilterPlaceholder" style="color: var(--text-muted);">选择标签</span>
                                    <!-- 选中的标签将动态添加到这里 -->
                                </div>
                                <!-- 清除按钮 -->
                                <button id="clearTagsBtn" style="padding: 0.3rem 0.8rem; background-color: var(--bg-color); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 0.9rem; min-height: 42px; box-sizing: border-box;">
                                    清除
                                </button>
                                <!-- 下拉选项区域 -->
                                <div id="tagFilterOptions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--surface-color); box-shadow: var(--shadow-md); max-height: 200px; overflow-y: auto; z-index: 100;">
                                    <!-- 标签选项将通过JavaScript动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="commands-list" id="commandsList">
                        <!-- 命令项将通过JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 变量赋值区 -->
                <div class="variables-section">
                    <h2>变量列表</h2>
                    <div class="variables-list" id="variablesList">
                        <!-- 变量项将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 命令管理页面 -->
            <div class="tab-content" id="command-management">
                <div class="management-page">
                    <h2>命令管理</h2>
                    
                    <!-- 添加命令表单 -->
                    <div class="add-command-form" style="margin-bottom: 2rem;">
                        <h3>添加新命令</h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <input type="text" id="newCmdTitle" placeholder="命令标题" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem;">
                            <textarea id="newCmdDescription" placeholder="命令描述（可选）" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem; min-height: 60px;"></textarea>
                            <div style="position: relative;">
                            <!-- 标签输入框 -->
                            <div id="newCmdTagsContainer" style="border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 0.5rem; min-height: 42px; cursor: text; background-color: var(--surface-color); display: flex; flex-wrap: wrap; gap: 0.3rem; align-items: center;">
                                <span id="newCmdTagsPlaceholder" style="color: var(--text-muted);">选择或输入标签</span>
                                <!-- 选中的标签将动态添加到这里 -->
                            </div>
                            <!-- 现有标签选项 -->
                            <div id="newCmdTagsOptions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background-color: var(--surface-color); box-shadow: var(--shadow-md); max-height: 200px; overflow-y: auto; z-index: 100;">
                                <!-- 现有标签将动态添加到这里 -->
                            </div>
                        </div>
                            <textarea id="newCmdTemplate" placeholder="命令模板（使用${{变量名}}的形式引用变量）" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem; font-family: 'SF Mono', 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace; min-height: 80px;"></textarea>
                            <button onclick="addCommand()" class="save-btn" style="align-self: flex-start;">添加命令</button>
                        </div>
                    </div>
                    
                    <!-- 命令列表 -->
                    <h3>现有命令</h3>
                    <div class="commands-list" id="commandManagementList">
                        <!-- 命令项将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 变量管理页面 -->
            <div class="tab-content" id="variable-management">
                <div class="management-page">
                    <h2>参数管理</h2>
                    
                    <!-- 添加变量表单 -->
                    <div class="add-variable-form" style="margin-bottom: 2rem;">
                        <h3>添加新变量</h3>
                        <div style="margin-bottom: 0.5rem;">
                            <input type="text" id="newVarName" placeholder="变量名" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem;">
                        </div>
                        <button onclick="addVariable()" class="save-btn" style="width: 100%;">添加变量</button>
                    </div>
                    
                    <!-- 变量列表 -->
                    <h3>现有变量</h3>
                    <div class="variables-list" id="variableManagementList">
                        <!-- 变量项将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 管理面板主页面 -->
            <div class="tab-content" id="management">
                <div class="management-page">
                    <h2>管理面板</h2>
                    
                    <!-- 二级导航菜单 -->
                    <div style="margin-bottom: 2rem;">
                        <div style="display: flex; gap: 1rem; border-bottom: 1px solid var(--border-color); flex-wrap: wrap;">
                            <div class="sub-tab-item active" data-subtab="command-management" style="padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 500; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); transition: var(--transition);">
                                命令管理
                            </div>
                            <div class="sub-tab-item" data-subtab="variable-management" style="padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 500; color: var(--text-secondary); transition: var(--transition);">
                                参数管理
                            </div>
                            <div class="sub-tab-item" data-subtab="column-management" style="padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 500; color: var(--text-secondary); transition: var(--transition);">
                                分栏管理
                            </div>
                            <div class="sub-tab-item" data-subtab="data-management" style="padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 500; color: var(--text-secondary); transition: var(--transition);">
                                数据管理
                            </div>
                        </div>
                    </div>
                    
                    <!-- 二级导航内容区域 -->
                    <div class="sub-tab-content active" id="management-command-management">
                        <!-- 命令管理内容 -->
                        <h3>添加新命令</h3>
                        <div class="add-command-form" style="margin-bottom: 2rem;">
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <input type="text" id="management-newCmdTitle" placeholder="命令标题" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem;">
                                <textarea id="management-newCmdDescription" placeholder="命令描述（可选）" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem; min-height: 60px;"></textarea>
                                <div style="position: relative;">
                                <!-- 标签输入框 -->
                                <div id="management-newCmdTagsContainer" style="border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 0.5rem; min-height: 42px; cursor: text; background-color: var(--surface-color); display: flex; flex-wrap: wrap; gap: 0.3rem; align-items: center;">
                                    <span id="management-newCmdTagsPlaceholder" style="color: var(--text-muted);">选择或输入标签</span>
                                    <!-- 选中的标签将动态添加到这里 -->
                                </div>
                                <!-- 现有标签选项 -->
                                <div id="management-newCmdTagsOptions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background-color: var(--surface-color); box-shadow: var(--shadow-md); max-height: 200px; overflow-y: auto; z-index: 100;">
                                    <!-- 现有标签将动态添加到这里 -->
                                </div>
                            </div>
                                <div>
                                    <label for="management-newCmdColumn" style="display: block; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">所属分栏</label>
                                    <div style="position: relative;">
                                        <div id="management-newCmdColumnContainer" style="border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 0.75rem; cursor: pointer; background-color: var(--surface-color);">
                                            <span id="management-newCmdColumnPlaceholder" style="color: var(--text-muted);">无分栏</span>
                                            <span id="management-newCmdColumnValue" style="color: var(--text-primary); display: none;"></span>
                                        </div>
                                        <!-- 分栏选项列表 -->
                                        <div id="management-newCmdColumnOptions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background-color: var(--surface-color); box-shadow: var(--shadow-md); max-height: 200px; overflow-y: auto; z-index: 100;">
                                            <!-- 分栏选项将通过JavaScript动态生成 -->
                                        </div>
                                        <!-- 隐藏的输入框，用于存储选中的分栏ID -->
                                        <input type="hidden" id="management-newCmdColumn" value="">
                                    </div>
                                </div>
                                <textarea id="management-newCmdTemplate" placeholder="命令模板（使用${{变量名}}的形式引用变量）" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem; font-family: 'SF Mono', 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace; min-height: 80px;"></textarea>
                                <button onclick="addManagementCommand()" class="save-btn" style="align-self: flex-start;">添加命令</button>
                            </div>
                        </div>
                        
                        <!-- 命令列表 -->
                        <h3>现有命令</h3>
                        <!-- 搜索和筛选区域 -->
                        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                            <!-- 搜索框 -->
                            <div style="flex: 1;">
                                <input type="text" id="management-commandSearch" placeholder="搜索命令（标题、描述或模板）" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem;">
                            </div>
                            <!-- 分栏筛选器 -->
                            <div style="width: 200px;">
                                <div style="position: relative;">
                                    <select id="management-columnFilter" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem; background-color: var(--surface-color); color: var(--text-primary); appearance: none; cursor: pointer;">
                                        <option value="">所有分栏</option>
                                        <!-- 分栏选项将通过JavaScript动态生成 -->
                                    </select>
                                    <div style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-muted);">▼</div>
                                </div>
                            </div>
                        </div>
                        <div class="commands-list" id="management-commandManagementList">
                            <!-- 命令项将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    
                    <div class="sub-tab-content" id="management-variable-management">
                        <!-- 变量管理内容 -->
                        <h3>添加新变量</h3>
                        <div class="add-variable-form" style="margin-bottom: 2rem;">
                            <div style="margin-bottom: 0.5rem;">
                                <input type="text" id="management-newVarName" placeholder="变量名" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem;">
                            </div>
                            <button onclick="addManagementVariable()" class="save-btn" style="width: 100%;">添加变量</button>
                        </div>
                        
                        <!-- 变量列表 -->
                        <h3>现有变量</h3>
                        <div class="variables-list" id="management-variableManagementList">
                            <!-- 变量项将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    
                    <div class="sub-tab-content" id="management-data-management">
                        <!-- 数据管理内容 -->
                        <h3>数据导出</h3>
                        <div style="margin-bottom: 2rem; padding: 1.5rem; background-color: #f0f2f5; border-radius: 8px;">
                            <p style="margin-bottom: 1rem; color: #666;">将当前所有数据导出为JSON文件，用于备份或迁移。</p>
                            <button onclick="exportData()" class="save-btn">
                                导出数据
                            </button>
                        </div>
                        
                        <h3>数据导入</h3>
                        <div style="margin-bottom: 2rem; padding: 1.5rem; background-color: #f0f2f5; border-radius: 8px;">
                            <p style="margin-bottom: 1rem; color: #666;">从JSON文件导入数据，可以选择全新导入或增量导入。</p>
                            <div style="margin-bottom: 1rem;">
                                <input type="file" id="importFile" accept=".json" style="display: none;">
                                <button type="button" onclick="document.getElementById('importFile').click()" class="save-btn" style="margin-bottom: 1rem;">
                                    选择文件
                                </button>
                                <span id="fileName" style="color: var(--text-secondary); margin-left: 0.5rem;">未选择文件</span>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="margin-right: 1rem;">
                                    <input type="radio" name="importType" value="full" checked> 全新导入（覆盖现有数据）
                                </label>
                                <label>
                                    <input type="radio" name="importType" value="incremental"> 增量导入（合并现有数据）
                                </label>
                            </div>
                            <button onclick="importData()" class="save-btn">
                                导入数据
                            </button>
                        </div>
                        
                        <h3>清除数据</h3>
                        <div style="padding: 1.5rem; background-color: #fef5f5; border: 1px solid #fed7d7; border-radius: 8px;">
                            <p style="margin-bottom: 1rem; color: #e53e3e;">警告：此操作将永久删除所有数据，包括命令和变量，请谨慎操作！</p>
                            <button onclick="clearAllData()" class="delete-btn">
                                清除所有数据
                            </button>
                        </div>
                    </div>
                    
                    <div class="sub-tab-content" id="management-column-management">
                        <!-- 分栏管理内容 -->
                        <h3>添加新分栏</h3>
                        <div class="add-column-form" style="margin-bottom: 2rem; background-color: var(--surface-color); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label for="newColumnName" style="display: block; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">分栏名称</label>
                                    <input type="text" id="newColumnName" placeholder="请输入分栏名称" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem;">
                                </div>
                                <button onclick="addColumn()" class="save-btn" style="align-self: flex-start;">添加分栏</button>
                            </div>
                        </div>
                        
                        <h3>现有分栏</h3>
                        <div class="columns-list" id="columnsList">
                            <!-- 分栏项将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>



    <!-- 编辑命令模态框 -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑命令</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                    <div>
                        <input type="text" id="editCmdTitle" placeholder="命令标题" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem; width: 100%;">
                        <div id="editCmdTitleError" class="error-message"></div>
                    </div>
                    <div>
                        <textarea id="editCmdDescription" placeholder="命令描述（可选）" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem; min-height: 60px; width: 100%;"></textarea>
                        <div id="editCmdDescriptionError" class="error-message"></div>
                    </div>
                    <div>
                        <div style="position: relative;">
                            <!-- 标签输入区域 -->
                            <div id="editCmdTagsContainer" style="border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 0.5rem; min-height: 42px; cursor: text; background-color: var(--surface-color); display: flex; flex-wrap: wrap; gap: 0.3rem; align-items: center;">
                                <span id="editCmdTagsPlaceholder" style="color: var(--text-muted);">选择或输入标签</span>
                                <!-- 选中的标签将动态添加到这里 -->
                            </div>
                            <!-- 现有标签选项 -->
                            <div id="editCmdTagsOptions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background-color: var(--surface-color); box-shadow: var(--shadow-md); max-height: 200px; overflow-y: auto; z-index: 100;">
                                <!-- 现有标签将动态添加到这里 -->
                            </div>
                        </div>
                        <div id="editCmdTagsError" class="error-message"></div>
                    </div>
                    <div>
                        <label for="editCmdColumn" style="display: block; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">所属分栏</label>
                        <div style="position: relative;">
                            <div id="editCmdColumnContainer" style="border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 0.75rem; cursor: pointer; background-color: var(--surface-color);">
                                <span id="editCmdColumnPlaceholder" style="color: var(--text-muted);">无分栏</span>
                                <span id="editCmdColumnValue" style="color: var(--text-primary); display: none;"></span>
                            </div>
                            <!-- 分栏选项列表 -->
                            <div id="editCmdColumnOptions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background-color: var(--surface-color); box-shadow: var(--shadow-md); max-height: 200px; overflow-y: auto; z-index: 100;">
                                <!-- 分栏选项将通过JavaScript动态生成 -->
                            </div>
                            <!-- 隐藏的输入框，用于存储选中的分栏ID -->
                            <input type="hidden" id="editCmdColumn" value="">
                        </div>
                        <div id="editCmdColumnError" class="error-message"></div>
                    </div>
                    <div>
                        <textarea id="editCmdTemplate" placeholder="命令模板（使用${{变量名}}的形式引用变量）" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem; font-family: 'SF Mono', 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace; min-height: 80px; width: 100%;"></textarea>
                        <div id="editCmdTemplateError" class="error-message"></div>
                    </div>
                </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeEditModal()">取消</button>
                <button class="save-btn" onclick="saveEditedCommand()">保存</button>
            </div>
        </div>
    </div>

    <!-- 自定义确认弹框 -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle">确认操作</h3>
                <button class="close-btn" onclick="closeConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">确定要执行此操作吗？</p>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeConfirmModal()">取消</button>
                <button class="delete-btn" onclick="confirmAction()">确认</button>
            </div>
        </div>
    </div>

    <!-- 编辑分栏模态框 -->
    <div id="editColumnModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑分栏</h3>
                <button class="close-btn" onclick="closeEditColumnModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div>
                    <input type="text" id="editColumnName" placeholder="分栏名称" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1rem; width: 100%;">
                    <div id="editColumnNameError" class="error-message"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeEditColumnModal()">取消</button>
                <button class="save-btn" onclick="saveEditedColumn()">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 从localStorage加载数据
        function loadData() {
            const savedVariables = localStorage.getItem('commandGeneratorVariables');
            const savedCommands = localStorage.getItem('commandGeneratorCommands');
            const savedColumns = localStorage.getItem('commandGeneratorColumns');
            const savedVariableOrder = localStorage.getItem('commandGeneratorVariableOrder');
            const hasClearedData = localStorage.getItem('commandGeneratorHasClearedData') === 'true';
            
            let parsedCommands = [];
            let parsedColumns = [];
            let parsedVariables = {};
            let parsedVariableOrder = [];
            
            if (savedCommands) {
                parsedCommands = JSON.parse(savedCommands);
                // 确保旧数据兼容新格式
                parsedCommands = parsedCommands.map((cmd, index) => ({
                    title: cmd.title,
                    template: cmd.template,
                    description: cmd.description || '',
                    tags: cmd.tags || [],
                    columnId: cmd.columnId || null,
                    sortOrder: cmd.sortOrder !== undefined ? cmd.sortOrder : index
                }));
            } else if (!hasClearedData) {
                // 只有当用户没有手动清除数据时，才显示示例命令
                // 创建三个分栏：Linux、Windows、SQL
                parsedColumns = [
                    {
                        id: 'column_linux',
                        name: 'Linux系统操作'
                    },
                    {
                        id: 'column_windows',
                        name: 'Windows系统操作'
                    },
                    {
                        id: 'column_sql',
                        name: 'SQL操作'
                    }
                ];
                
                // 创建6条命令，分别分配到对应分栏
                parsedCommands = [
                    // Linux系统操作命令
                    {
                        title: 'Linux创建用户',
                        template: 'sudo useradd -m -s /bin/bash ${{USER_NAME}}',
                        description: '在Linux系统中创建新用户',
                        tags: ['linux', 'user', 'sudo'],
                        columnId: 'column_linux',
                        sortOrder: 0
                    },
                    {
                        title: 'Linux文件权限',
                        template: 'chmod ${{PERMISSIONS}} ${{FILE_PATH}}',
                        description: '修改Linux文件或目录的权限',
                        tags: ['linux', 'permission', 'chmod'],
                        columnId: 'column_linux',
                        sortOrder: 1
                    },
                    // Windows系统操作命令
                    {
                        title: 'Windows创建目录',
                        template: 'mkdir ${{DIR_PATH}}',
                        description: '在Windows系统中创建新目录',
                        tags: ['windows', 'directory', 'cmd'],
                        columnId: 'column_windows',
                        sortOrder: 2
                    },
                    {
                        title: 'Windows查看进程',
                        template: 'tasklist /fi "imagename eq ${{PROCESS_NAME}}.exe"',
                        description: '在Windows系统中查看指定进程',
                        tags: ['windows', 'process', 'tasklist'],
                        columnId: 'column_windows',
                        sortOrder: 3
                    },
                    // SQL操作命令
                    {
                        title: 'SQL查询数据',
                        template: 'SELECT * FROM ${{TABLE_NAME}} WHERE ${{CONDITION}}',
                        description: '在SQL数据库中查询数据',
                        tags: ['sql', 'select', 'query'],
                        columnId: 'column_sql',
                        sortOrder: 4
                    },
                    {
                        title: 'SQL插入数据',
                        template: 'INSERT INTO ${{TABLE_NAME}} (${{COLUMNS}}) VALUES (${{VALUES}})',
                        description: '向SQL表中插入新数据',
                        tags: ['sql', 'insert', 'data'],
                        columnId: 'column_sql',
                        sortOrder: 5
                    }
                ];
            }
            
            if (savedColumns) {
                parsedColumns = JSON.parse(savedColumns);
                // 移除旧数据中的order属性，因为我们不再使用它
                parsedColumns = parsedColumns.map(col => ({
                    id: col.id,
                    name: col.name
                }));
            }
            
            if (savedVariables) {
                parsedVariables = JSON.parse(savedVariables);
            } else if (!hasClearedData) {
                // 只有当用户没有手动清除数据时，才显示示例变量
                parsedVariables = {
                    // Linux系统变量
                    USER_NAME: 'newuser',
                    PERMISSIONS: '755',
                    FILE_PATH: '/home/user/file.txt',
                    // Windows系统变量
                    DIR_PATH: 'C:\NewFolder',
                    PROCESS_NAME: 'chrome',
                    // SQL变量
                    TABLE_NAME: 'users',
                    CONDITION: 'id = 1',
                    COLUMNS: 'name, email, password',
                    VALUES: "'John', 'john@example.com', 'password123'"
                };
            }
            
            // 加载变量排序顺序
            if (savedVariableOrder) {
                parsedVariableOrder = JSON.parse(savedVariableOrder);
                // 确保排序顺序中的变量名在parsedVariables中都存在
                parsedVariableOrder = parsedVariableOrder.filter(varName => parsedVariables.hasOwnProperty(varName));
            } else {
                // 如果没有保存的排序顺序，使用变量名的字母顺序
                parsedVariableOrder = Object.keys(parsedVariables).sort();
            }
            
            return {
                variables: parsedVariables,
                variableOrder: parsedVariableOrder,
                commands: parsedCommands,
                columns: parsedColumns
            };
        }

        // Toast 提示函数
        function showToast(message, type = 'success') {
            // 获取或创建toast容器
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container';
                document.body.appendChild(toastContainer);
            }
            
            // 创建新的Toast元素
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            // 获取当前容器中的toast数量，设置新toast的top位置
            const toastCount = toastContainer.children.length;
            toast.style.top = `${toastCount * 60}px`; // 60px是每个toast的高度加上间距
            
            // 添加到toast容器中
            toastContainer.appendChild(toast);
            
            // 显示Toast
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // 3秒后隐藏并移除元素
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                // 等待动画结束后移除元素
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                        // 如果容器为空，移除容器
                        if (toastContainer.children.length === 0) {
                            toastContainer.parentNode.removeChild(toastContainer);
                        }
                    }
                }, 300);
            }, 3000);
        }
        
        // 自定义确认弹框相关变量
        let confirmCallback = null;
        let confirmTitle = '';
        let confirmMessage = '';
        
        // 显示确认弹框
        function showConfirmModal(title, message, callback) {
            const modal = document.getElementById('confirmModal');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            
            confirmTitle = title;
            confirmMessage = message;
            confirmCallback = callback;
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            messageEl.innerHTML = message.replace(/\n/g, '<br>');
            
            modal.classList.add('show');
        }
        
        // 关闭确认弹框
        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('show');
            confirmCallback = null;
        }
        
        // 确认操作
        function confirmAction() {
            if (confirmCallback) {
                const callback = confirmCallback;
                closeConfirmModal();
                callback();
            } else {
                closeConfirmModal();
            }
        }

        // 保存数据到localStorage
        function saveData() {
            localStorage.setItem('commandGeneratorVariables', JSON.stringify(variables));
            localStorage.setItem('commandGeneratorVariableOrder', JSON.stringify(variableOrder));
            localStorage.setItem('commandGeneratorCommands', JSON.stringify(commands));
            localStorage.setItem('commandGeneratorColumns', JSON.stringify(columns));
            // 如果有数据保存，清除清除数据标志
            if (Object.keys(variables).length > 0 || commands.length > 0 || columns.length > 0) {
                localStorage.removeItem('commandGeneratorHasClearedData');
            }
        }

        // 存储变量值
        let variables = loadData().variables;

        // 变量排序顺序
        let variableOrder = loadData().variableOrder;

        // 命令模板
        let commands = loadData().commands;

        // 分栏数据
        let columns = loadData().columns;

        // 当前编辑的命令索引
        let currentEditIndex = -1;
        
        // 当前编辑的分栏索引
        let currentEditColumnIndex = -1;
        
        // 活跃标签筛选
        let activeTags = [];
        
        // 活跃分栏ID
        let activeColumnId = null;
        
        // 搜索关键词
        let searchKeyword = '';

        // 自动退出排序模式
        function autoExitSortMode() {
            if (activeSortListType) {
                // 移除所有列表的排序模式
                const listElements = document.querySelectorAll(`[data-list-type="${activeSortListType}"]`);
                listElements.forEach(el => {
                    el.draggable = false;
                    el.style.cursor = '';
                });
                
                // 更新排序按钮状态
                const currentSortButtons = document.querySelectorAll(`button[data-sort-type="${activeSortListType}"]`);
                currentSortButtons.forEach(btn => {
                    btn.style.backgroundColor = 'var(--primary-color)';
                    btn.textContent = '☰ 拖动排序';
                });
                
                // 关闭排序模式
                activeSortListType = null;
            }
        }
        
        // 二级导航切换功能
        function initSubTabSystem() {
            // 移除所有现有的事件监听器，避免重复绑定
            document.querySelectorAll('.sub-tab-item').forEach(item => {
                item.onclick = null;
            });
            
            const subTabItems = document.querySelectorAll('.sub-tab-item');
            
            subTabItems.forEach(item => {
                item.addEventListener('click', () => {
                    // 自动退出排序模式
                    autoExitSortMode();
                    
                    // 移除所有active类
                    subTabItems.forEach(i => {
                        i.classList.remove('active');
                        i.style.color = 'var(--text-secondary)';
                        i.style.borderBottom = 'none';
                    });
                    document.querySelectorAll('.sub-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // 添加当前subTab的active类
                    item.classList.add('active');
                    item.style.color = 'var(--primary-color)';
                    item.style.borderBottom = '2px solid var(--primary-color)';
                    
                    const subTabId = item.dataset.subtab;
                    document.getElementById(`management-${subTabId}`).classList.add('active');
                    
                    // 根据切换的子标签更新相应的列表
                    if (subTabId === 'command-management') {
                        updateCommandManagementList();
                    } else if (subTabId === 'variable-management') {
                        updateVariableManagementList();
                    } else if (subTabId === 'column-management') {
                        updateColumnsList();
                    } else if (subTabId === 'data-management') {
                        // 数据管理不需要特殊更新，直接显示即可
                    }
                });
            });
        }

        // Tab切换功能
        function initTabSystem() {
            const tabItems = document.querySelectorAll('.tab-item');
            
            tabItems.forEach(item => {
                item.addEventListener('click', () => {
                    // 自动退出排序模式
                    autoExitSortMode();
                    
                    // 移除所有active类
                    tabItems.forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // 添加当前tab的active类
                    item.classList.add('active');
                    const tabId = item.dataset.tab;
                    
                    // 检查是否是分栏菜单项
                    if (tabId.startsWith('column_')) {
                        // 分栏菜单项：显示主页面，并筛选该分栏下的命令和变量
                        document.getElementById('main').classList.add('active');
                        
                        // 更新活跃分栏ID
                        activeColumnId = tabId;
                        
                        // 更新命令列表和变量列表
                        updateCommands();
                        updateVariablesList();
                    } else {
                        // 普通菜单项：直接显示对应的内容
                        document.getElementById(tabId).classList.add('active');
                        
                        // 重置活跃分栏ID
                        activeColumnId = null;
                        
                        // 根据切换的标签更新相应的列表
                        if (tabId === 'management') {
                            // 切换到管理面板时，初始化二级导航
                            initSubTabSystem();
                            updateCommandManagementList();
                            updateVariableManagementList();
                        } else if (tabId === 'main') {
                            // 切换到主页面时，更新变量列表和命令列表
                            updateVariablesList();
                            updateCommands();
                        }
                    }
                });
            });
        }

        // 从命令模板中提取所有变量名 - 使用${{变量名}}格式
        function extractVariablesFromCommands() {
            const variablesSet = new Set();
            
            // 筛选当前显示的命令，使用与updateCommands相同的筛选逻辑
            const filteredCommands = commands.filter(command => {
                let showCommand = true;
                
                // 1. 分栏筛选
                if (activeColumnId) {
                    if (command.columnId !== activeColumnId) {
                        showCommand = false;
                    }
                }
                
                // 2. 标签筛选
                if (showCommand && activeTags.length > 0) {
                    const hasMatchingTag = command.tags.some(tag => activeTags.includes(tag));
                    if (!hasMatchingTag) {
                        showCommand = false;
                    }
                }
                
                // 3. 搜索筛选
                if (showCommand && searchKeyword) {
                    const searchableText = `${command.title} ${command.description || ''} ${command.template}`.toLowerCase();
                    if (!searchableText.includes(searchKeyword)) {
                        showCommand = false;
                    }
                }
                
                return showCommand;
            });
            
            filteredCommands.forEach(command => {
                const matches = command.template.match(/\$\{\{([A-Za-z0-9_]+)\}\}/g) || [];
                matches.forEach(match => {
                    // 去掉${{和}}符号，并转换为大写
                    const varName = match.substring(3, match.length - 2).toUpperCase();
                    variablesSet.add(varName);
                });
            });
            
            // 获取所有使用的变量
            const usedVariables = Array.from(variablesSet);
            
            // 按照variableOrder排序，不在排序列表中的变量放在后面
            const sortedVariables = [...usedVariables].sort((a, b) => {
                const indexA = variableOrder.indexOf(a);
                const indexB = variableOrder.indexOf(b);
                
                // 都在排序列表中，按列表顺序
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                // 只有a在排序列表中，a在前
                if (indexA !== -1) {
                    return -1;
                }
                // 只有b在排序列表中，b在前
                if (indexB !== -1) {
                    return 1;
                }
                // 都不在排序列表中，按字母顺序
                return a.localeCompare(b);
            });
            
            return sortedVariables;
        }
        
        // 提取所有唯一标签
        function getAllUniqueTags() {
            const tagsSet = new Set();
            
            commands.forEach(command => {
                if (command.tags && command.tags.length > 0) {
                    command.tags.forEach(tag => {
                        tagsSet.add(tag);
                    });
                }
            });
            
            return Array.from(tagsSet).sort();
        }
        
        // 更新自定义标签筛选下拉框
        function updateCustomTagFilter() {
            const tagFilterContainer = document.getElementById('tagFilterContainer');
            const tagFilterOptions = document.getElementById('tagFilterOptions');
            const allTags = getAllUniqueTags();
            
            // 清空选项
            tagFilterOptions.innerHTML = '';
            
            // 添加所有标签选项
            allTags.forEach(tag => {
                const option = document.createElement('div');
                option.style.padding = '0.5rem';
                option.style.cursor = 'pointer';
                option.style.display = 'flex';
                option.style.alignItems = 'center';
                option.style.gap = '0.5rem';
                option.style.transition = 'background-color 0.2s';
                option.onmouseenter = () => option.style.backgroundColor = '#f0f2f5';
                option.onmouseleave = () => option.style.backgroundColor = '';
                
                // 复选框
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `tag_${tag}`;
                checkbox.checked = activeTags.includes(tag);
                checkbox.style.margin = '0';
                
                // 标签文本（不再使用label，避免事件冲突）
                const tagText = document.createElement('span');
                tagText.textContent = tag;
                tagText.style.flex = '1';
                tagText.style.cursor = 'pointer';
                
                // 点击整个条目切换复选框状态
                const toggleCheckbox = () => {
                    // 切换复选框状态
                    checkbox.checked = !checkbox.checked;
                    // 更新activeTags数组
                    if (checkbox.checked) {
                        if (!activeTags.includes(tag)) {
                            activeTags.push(tag);
                        }
                    } else {
                        activeTags = activeTags.filter(t => t !== tag);
                    }
                    // 更新显示
                    updateSelectedTagsDisplay();
                    updateCommands();
                };
                
                // 点击整个选项时切换状态
                option.addEventListener('click', (e) => {
                    toggleCheckbox();
                    // 阻止事件冒泡，避免触发容器的点击事件
                    e.stopPropagation();
                });
                
                // 点击文本时也切换状态
                tagText.addEventListener('click', (e) => {
                    toggleCheckbox();
                    // 阻止事件冒泡
                    e.stopPropagation();
                });
                
                // 点击复选框时也切换状态
                checkbox.addEventListener('click', (e) => {
                    toggleCheckbox();
                    // 阻止事件冒泡
                    e.stopPropagation();
                });
                
                option.appendChild(checkbox);
                option.appendChild(tagText);
                tagFilterOptions.appendChild(option);
            });
            
            // 更新选中标签显示
            updateSelectedTagsDisplay();
        }
        
        // 更新选中标签的显示
        function updateSelectedTagsDisplay() {
            const container = document.getElementById('tagFilterContainer');
            const placeholder = document.getElementById('tagFilterPlaceholder');
            
            // 移除所有已选中的标签
            const existingTags = container.querySelectorAll('.selected-tag');
            existingTags.forEach(tag => tag.remove());
            
            // 如果有选中的标签，隐藏占位符并显示标签
            if (activeTags.length > 0) {
                placeholder.style.display = 'none';
                
                activeTags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'selected-tag';

                    
                    // 标签文本
                    const tagText = document.createTextNode(tag);
                    tagElement.appendChild(tagText);
                    
                    // 删除按钮
                    const deleteBtn = document.createElement('span');
                    deleteBtn.textContent = '×';
                    deleteBtn.style.fontSize = '1rem';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.style.marginLeft = '0.2rem';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        activeTags = activeTags.filter(t => t !== tag);
                        updateCustomTagFilter();
                        updateCommands();
                    };
                    
                    tagElement.appendChild(deleteBtn);
                    container.appendChild(tagElement);
                });
            } else {
                // 没有选中的标签，显示占位符
                placeholder.style.display = 'inline';
            }
        }

        // 初始化搜索功能
        function initSearch() {
            const searchInput = document.getElementById('searchInput');
            const tagFilterContainer = document.getElementById('tagFilterContainer');
            const tagFilterOptions = document.getElementById('tagFilterOptions');
            const clearTagsBtn = document.getElementById('clearTagsBtn');
            let isDropdownOpen = false;
            
            // 搜索输入事件
            searchInput.addEventListener('input', (e) => {
                searchKeyword = e.target.value.toLowerCase().trim();
                updateCommands();
            });
            
            // 切换下拉框显示
            tagFilterContainer.addEventListener('click', () => {
                isDropdownOpen = !isDropdownOpen;
                tagFilterOptions.style.display = isDropdownOpen ? 'block' : 'none';
            });
            
            // 点击页面其他地方关闭下拉框
            document.addEventListener('click', (e) => {
                if (!tagFilterContainer.contains(e.target) && !tagFilterOptions.contains(e.target)) {
                    isDropdownOpen = false;
                    tagFilterOptions.style.display = 'none';
                }
            });
            
            // 清除标签筛选按钮点击事件
            clearTagsBtn.addEventListener('click', () => {
                activeTags = [];
                updateCustomTagFilter();
                updateCommands();
            });
        }
        
        // 自动添加命令中的新变量到变量管理
        function autoAddVariablesFromCommand(commandTemplate) {
            const matches = commandTemplate.match(/\$\{\{([A-Za-z0-9_]+)\}\}/g) || [];
            let hasNewVariable = false;
            
            matches.forEach(match => {
                // 去掉${{和}}符号，并转换为大写
                const varName = match.substring(3, match.length - 2).toUpperCase();
                if (!variables[varName]) {
                    variables[varName] = ''; // 初始值为空字符串
                    hasNewVariable = true;
                }
            });
            
            return hasNewVariable;
        }

        // 更新变量列表 - 显示所有命令中使用的变量（主页面只有编辑功能，没有删除按钮）
        function updateVariablesList() {
            const variablesList = document.getElementById('variablesList');
            const allVariables = extractVariablesFromCommands();
            const isSorting = activeSortListType === 'variables';
            
            variablesList.innerHTML = '';
            
            // 添加排序按钮
            const sortContainer = document.createElement('div');
            sortContainer.style.cssText = 'display: flex; justify-content: flex-end; margin-bottom: 1rem;';
            sortContainer.innerHTML = `
                <button onclick="toggleSortMode('variables')" data-sort-type="variables" 
                        style="padding: 0.5rem 1rem; ${isSorting ? 'background-color: var(--success-color);' : 'background-color: var(--primary-color);'} 
                               color: white; border: none; border-radius: var(--border-radius-sm); 
                               cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                    ${isSorting ? '✓ 点击退出' : '☰ 拖动排序'}
                </button>
            `;
            variablesList.appendChild(sortContainer);
            
            allVariables.forEach(varName => {
                const value = variables[varName] || `[${varName}_PLACEHOLDER]`;
                
                const variableItem = document.createElement('div');
                variableItem.className = 'variable-item';
                variableItem.dataset.listType = 'variables';
                variableItem.dataset.varName = varName;
                variableItem.dataset.index = allVariables.indexOf(varName);
                
                variableItem.innerHTML = `
                    <div class="variable-name">
                        <span style="cursor: move; margin-right: 0.5rem; opacity: 0.6;">☰</span>
                        ${varName}
                    </div>
                    <div class="variable-value" onclick="editVariable(this)">${value}</div>
                `;
                
                // 添加拖动事件监听器（如果当前处于排序模式）
                if (isSorting) {
                    variableItem.draggable = true;
                    variableItem.style.cursor = 'move';
                    variableItem.addEventListener('dragstart', handleDragStart);
                    variableItem.addEventListener('dragover', handleDragOver);
                    variableItem.addEventListener('drop', handleDrop);
                    variableItem.addEventListener('dragend', handleDragEnd);
                }
                
                variablesList.appendChild(variableItem);
            });
        }

        // 渲染标签列表
        function renderTags(tags) {
            if (!tags || tags.length === 0) {
                return '';
            }
            
            return `<div class="command-tags">
                ${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
            </div>`;
        }

        // 更新分栏筛选器选项
        function updateColumnFilter() {
            const columnFilter = document.getElementById('management-columnFilter');
            if (!columnFilter) return;
            
            // 保存当前选中的值
            const currentValue = columnFilter.value;
            
            // 清空现有选项，保留默认选项
            columnFilter.innerHTML = '<option value="">所有分栏</option>';
            
            // 添加分栏选项
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.name;
                columnFilter.appendChild(option);
            });
            
            // 恢复选中的值
            columnFilter.value = currentValue;
        }
        
        // 更新命令管理列表
        function updateCommandManagementList() {
            // 获取搜索关键词
            const searchInput = document.getElementById('management-commandSearch');
            const searchKeyword = searchInput ? searchInput.value.toLowerCase().trim() : '';
            
            // 获取分栏筛选值
            const columnFilter = document.getElementById('management-columnFilter');
            const selectedColumnId = columnFilter ? columnFilter.value : '';
            
            // 处理命令列表的函数
            function processCommandsList(listElement) {
                listElement.innerHTML = '';
                
                // 过滤命令
                const filteredCommands = commands.filter(command => {
                    // 搜索过滤
                    const matchesSearch = !searchKeyword || 
                        `${command.title} ${command.description || ''} ${command.template}`.toLowerCase().includes(searchKeyword);
                    
                    // 分栏过滤
                    const matchesColumn = !selectedColumnId || 
                        command.columnId === selectedColumnId;
                    
                    return matchesSearch && matchesColumn;
                });
                
                filteredCommands.forEach((command, index) => {
                    // 找到原始索引，用于编辑和删除操作
                    const originalIndex = commands.indexOf(command);
                    
                    const commandItem = document.createElement('div');
                    commandItem.className = 'command-item';
                    
                    let descriptionHtml = '';
                    if (command.description) {
                        descriptionHtml = `<div class="command-description">${command.description}</div>`;
                    }
                    
                    // 将命令模板按换行符分割成多个代码块
                    const templateLines = command.template.split('\n').filter(line => line.trim() !== '');
                    
                    // 命令头和描述
                    let commandHtml = `
                        <div class="command-header">
                            <h3 class="command-title">${command.title}</h3>
                            <div class="command-actions">
                                <button class="edit-btn" onclick="openEditModal(${originalIndex})">编辑</button>
                                <button class="delete-btn" onclick="deleteCommand(${originalIndex})">删除</button>
                            </div>
                        </div>
                        ${descriptionHtml}
                        ${renderTags(command.tags)}
                    `;
                    
                    // 为每一行命令创建一个代码块
                    templateLines.forEach((line, lineIndex) => {
                        commandHtml += `
                            <div class="code-block" style="margin-top: 1rem;">
                                <pre>${line}</pre>
                            </div>
                        `;
                    });
                    
                    commandItem.innerHTML = commandHtml;
                    listElement.appendChild(commandItem);
                });
            }
            
            // 更新原命令管理页面的列表
            const commandsList = document.getElementById('commandManagementList');
            if (commandsList) {
                processCommandsList(commandsList);
            }
            
            // 更新管理面板中的命令列表
            const managementCommandsList = document.getElementById('management-commandManagementList');
            if (managementCommandsList) {
                processCommandsList(managementCommandsList);
            }
        }
        
        // 初始化管理面板搜索和筛选功能
        function initManagementSearch() {
            const searchInput = document.getElementById('management-commandSearch');
            const columnFilter = document.getElementById('management-columnFilter');
            
            // 搜索输入事件
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    updateCommandManagementList();
                });
            }
            
            // 分栏筛选事件
            if (columnFilter) {
                columnFilter.addEventListener('change', () => {
                    updateCommandManagementList();
                });
            }
        }

        // 更新变量管理列表
        function updateVariableManagementList() {
            // 处理变量列表的函数
            function processVariablesList(listElement) {
                listElement.innerHTML = '';
                
                // 添加变量项，按照variableOrder排序
                const sortedVariableNames = [...variableOrder].filter(name => variables.hasOwnProperty(name));
                
                sortedVariableNames.forEach(name => {
                    const value = variables[name];
                    const variableItem = document.createElement('div');
                    variableItem.className = 'variable-item';
                    
                    variableItem.innerHTML = `
                        <div class="variable-name">${name}</div>
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem;">
                            <div class="variable-value" onclick="editVariable(this)" style="flex: 1;">${value}</div>
                            <button onclick="deleteVariable('${name}')" class="delete-btn" style="padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; border-radius: 6px; white-space: nowrap;">删除</button>
                        </div>
                    `;
                    listElement.appendChild(variableItem);
                });
            }
            
            // 更新原变量管理页面的列表
            const variablesList = document.getElementById('variableManagementList');
            if (variablesList) {
                processVariablesList(variablesList);
            }
            
            // 更新管理面板中的变量列表
            const managementVariablesList = document.getElementById('management-variableManagementList');
            if (managementVariablesList) {
                processVariablesList(managementVariablesList);
            }
        }

        // 拖动排序相关函数
        let draggedElement = null;
        let draggedListType = ''; // 'commands', 'variables', or 'columns'
        let dragOverCounter = 0;
        
        // 开始拖动
        function handleDragStart(e) {
            draggedElement = this;
            draggedListType = this.dataset.listType;
            
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            
            // 设置拖动数据，确保可以正确处理拖动
            e.dataTransfer.setData('text/plain', '');
            
            // 重置计数器
            dragOverCounter = 0;
        }
        
        // 拖动经过
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // 增加计数器
            dragOverCounter++;
            
            // 获取当前元素的父容器
            let container;
            if (this.classList.contains('variables-list') || this.classList.contains('commands-list') || this.classList.contains('columns-list')) {
                container = this;
            } else {
                container = this.parentNode;
            }
            
            // 获取插入位置
            const afterElement = getDragAfterElement(container, e.clientY);
            const draggable = document.querySelector('.dragging');
            
            // 移动元素，让用户能看到拖动效果
            if (afterElement == null) {
                container.appendChild(draggable);
            } else {
                container.insertBefore(draggable, afterElement);
            }
        }
        
        // 拖动离开
        function handleDragLeave(e) {
            e.preventDefault();
            
            // 减少计数器
            dragOverCounter--;
        }
        
        // 放置元素
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // 重置计数器
            dragOverCounter = 0;
        }
        
        // 拖动结束
        function handleDragEnd(e) {
            // 移除拖动类
            this.classList.remove('dragging');
            
            // 直接处理排序，不依赖元素位置检测
            if (draggedListType === 'columns') {
                const container = document.getElementById('columnsList');
                // 获取所有command-item元素，这些元素已经按照拖动后的顺序排列
                const commandItems = Array.from(container.querySelectorAll('.command-item'));
                
                // 直接根据元素在容器中的顺序重新排列columns数组
                // 不需要复杂的名称匹配，直接获取元素的data-index属性
                const newColumns = commandItems.map(item => {
                    const index = parseInt(item.dataset.index);
                    return columns[index];
                }).filter(column => column);
                
                // 更新columns数组
                columns = newColumns;
                
                updateColumnsList();
                updateColumnSelectors();
            } else if (draggedListType === 'commands') {
                const container = document.getElementById('commandsList');
                Array.from(container.querySelectorAll('.command-item')).forEach((item, newIndex) => {
                    const index = parseInt(item.dataset.index);
                    if (!isNaN(index) && commands[index]) {
                        commands[index].sortOrder = newIndex;
                    }
                });
                updateCommandManagementList();
            } else if (draggedListType === 'variables') {
                const container = document.getElementById('variablesList');
                const newVariableOrder = Array.from(container.querySelectorAll('.variable-item'))
                    .map(item => item.dataset.varName)
                    .filter(varName => varName);
                
                // 确保所有变量都包含在新的排序中
                const allVariables = extractVariablesFromCommands();
                const remainingVariables = allVariables.filter(name => !newVariableOrder.includes(name));
                variableOrder = [...newVariableOrder, ...remainingVariables];
                updateVariableManagementList();
            }
            
            // 保存到localStorage并重置状态
            saveData();
            draggedElement = null;
            draggedListType = '';
        }
        
        // 获取拖动元素应该插入到哪个元素之后
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // 保存排序结果（现在只是一个空函数，保持API兼容）
        function saveSortResult(listType) {
            // 拖动结束时已经保存了排序结果，这里不需要做任何事情
            // 保持这个函数是为了兼容现有的代码结构
        }
        
        // 当前激活的排序列表类型
        let activeSortListType = null;
        
        // 切换拖动排序模式
        function toggleSortMode(listType) {
            const isCurrentlyActive = activeSortListType === listType;
            const sortButtons = document.querySelectorAll(`button[data-sort-type="${listType}"]`);
            
            // 更新按钮状态的辅助函数
            const updateButtons = (buttons, isActive) => {
                buttons.forEach(btn => {
                    btn.style.backgroundColor = isActive ? 'var(--success-color)' : 'var(--primary-color)';
                    btn.textContent = isActive ? '✓ 点击退出' : '☰ 拖动排序';
                });
            };
            
            if (isCurrentlyActive) {
                // 退出排序模式
                activeSortListType = null;
                updateButtons(sortButtons, false);
                showToast('已退出排序模式', 'success');
            } else {
                // 移除之前列表的排序模式
                if (activeSortListType) {
                    const previousSortButtons = document.querySelectorAll(`button[data-sort-type="${activeSortListType}"]`);
                    updateButtons(previousSortButtons, false);
                }
                
                // 进入当前列表的排序模式
                activeSortListType = listType;
                updateButtons(sortButtons, true);
                showToast('进入排序模式，拖动项目调整顺序（自动保存）', 'success');
            }
            
            // 重新渲染列表
            if (listType === 'commands') {
                updateCommands();
            } else if (listType === 'variables') {
                updateVariablesList();
            } else if (listType === 'columns') {
                updateColumnsList();
            }
        }
        
        // 更新分栏列表
        function updateColumnsList() {
            const columnsList = document.getElementById('columnsList');
            if (!columnsList) return;
            
            // 保存当前排序状态
            const isSorting = activeSortListType === 'columns';
            
            columnsList.innerHTML = '';
            
            // 添加排序按钮
            const sortContainer = document.createElement('div');
            sortContainer.style.display = 'flex';
            sortContainer.style.justifyContent = 'flex-end';
            sortContainer.style.marginBottom = '1rem';
            
            // 根据当前排序状态设置按钮样式和文本
            const buttonStyle = isSorting ? 
                'background-color: var(--success-color);' : 
                'background-color: var(--primary-color);';
            const buttonText = isSorting ? 
                '✓ 点击退出' : 
                '☰ 拖动排序';
            
            sortContainer.innerHTML = `
                <button onclick="toggleSortMode('columns')" data-sort-type="columns" style="padding: 0.5rem 1rem; ${buttonStyle} color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                    ${buttonText}
                </button>
            `;
            columnsList.appendChild(sortContainer);
            
            if (columns.length === 0) {
                columnsList.innerHTML += '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">暂无分栏，请添加新分栏</p>';
                return;
            }
            
            columns.forEach((column, index) => {
                const columnItem = document.createElement('div');
                columnItem.className = 'command-item';
                columnItem.dataset.index = index;
                columnItem.dataset.listType = 'columns';
                
                columnItem.innerHTML = `
                    <div class="command-header">
                        <h3 class="command-title">
                            <span style="cursor: move; margin-right: 0.5rem; opacity: 0.6;">☰</span>
                            ${column.name}
                        </h3>
                        <div class="command-actions">
                            <button class="edit-btn" onclick="editColumn(${index})">编辑</button>
                            <button class="delete-btn" onclick="deleteColumn(${index})">删除</button>
                        </div>
                    </div>
                `;
                
                // 添加拖动事件监听器（如果当前处于排序模式）
                if (isSorting) {
                    columnItem.draggable = true;
                    columnItem.style.cursor = 'move';
                    columnItem.addEventListener('dragstart', handleDragStart);
                    columnItem.addEventListener('dragover', handleDragOver);
                    columnItem.addEventListener('drop', handleDrop);
                    columnItem.addEventListener('dragend', handleDragEnd);
                }
                
                columnsList.appendChild(columnItem);
            });
            
            // 为容器添加dragover事件，以便在空白区域也能放置
            columnsList.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
        }
        
        // 添加新分栏
        function addColumn() {
            const nameInput = document.getElementById('newColumnName');
            
            const name = nameInput.value.trim();
            
            // 清除之前的错误
            nameInput.classList.remove('input-error');
            
            if (!name) {
                nameInput.classList.add('input-error');
                showToast('请输入分栏名称', 'error');
                return;
            }
            
            // 生成唯一ID
            const id = `column_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
            
            // 添加到分栏列表
            columns.push({
                id: id,
                name: name
            });
            
            // 保存数据到localStorage
            saveData();
            
            // 更新分栏列表
            updateColumnsList();
            
            // 更新命令管理中的分栏选择器
            updateColumnSelectors();
            
            // 更新分栏筛选器选项
            updateColumnFilter();
            
            // 清空输入框
            nameInput.value = '';
            
            // 显示成功提示
            showToast('分栏添加成功', 'success');
        }
        
        // 打开分栏编辑模态框
        function openEditColumnModal(index) {
            const column = columns[index];
            currentEditColumnIndex = index;
            
            // 填充表单数据
            document.getElementById('editColumnName').value = column.name;
            
            // 清除错误信息
            document.getElementById('editColumnName').classList.remove('input-error');
            document.getElementById('editColumnNameError').textContent = '';
            
            // 显示模态框
            document.getElementById('editColumnModal').classList.add('show');
        }
        
        // 关闭分栏编辑模态框
        function closeEditColumnModal() {
            document.getElementById('editColumnModal').classList.remove('show');
            currentEditColumnIndex = -1;
        }
        
        // 保存编辑的分栏
        function saveEditedColumn() {
            if (currentEditColumnIndex === -1) return;
            
            const nameInput = document.getElementById('editColumnName');
            const name = nameInput.value.trim();
            
            // 清除之前的错误
            nameInput.classList.remove('input-error');
            document.getElementById('editColumnNameError').textContent = '';
            
            let hasError = false;
            
            if (!name) {
                nameInput.classList.add('input-error');
                document.getElementById('editColumnNameError').textContent = '分栏名称不能为空';
                hasError = true;
            }
            
            if (hasError) {
                showToast('请检查输入信息', 'error');
                return;
            }
            
            // 更新分栏数据
            columns[currentEditColumnIndex].name = name;
            
            // 保存数据到localStorage
            saveData();
            
            // 更新分栏列表
            updateColumnsList();
            
            // 更新命令管理中的分栏选择器
            updateColumnSelectors();
            
            // 更新分栏筛选器选项
            updateColumnFilter();
            
            // 关闭模态框
            closeEditColumnModal();
            
            // 显示成功提示
            showToast('分栏编辑成功', 'success');
        }
        
        // 编辑分栏
        function editColumn(index) {
            openEditColumnModal(index);
        }
        
        // 删除分栏
        function deleteColumn(index) {
            const column = columns[index];
            showConfirmModal(
                '确认删除分栏',
                `确定要删除分栏 "${column.name}" 吗？该分栏下的命令将恢复为未分配状态。`,
                () => {
                    // 先将该分栏下的命令恢复为未分配状态
                    commands.forEach(cmd => {
                        if (cmd.columnId === column.id) {
                            cmd.columnId = null;
                        }
                    });
                    
                    // 删除分栏
                    columns.splice(index, 1);
                    
                    // 保存数据到localStorage
                    saveData();
                    
                    // 更新分栏列表
                    updateColumnsList();
                    
                    // 更新命令管理中的分栏选择器
                    updateColumnSelectors();
                    
                    // 更新分栏筛选器选项
                    updateColumnFilter();
                    
                    // 显示成功提示
                    showToast('分栏删除成功', 'success');
                }
            );
        }
        
        // 更新所有分栏选择器
        function updateColumnSelectors() {
            // 分栏选择器的前缀列表
            const selectors = ['management-newCmdColumn', 'editCmdColumn'];
            
            selectors.forEach(selectorId => {
                const hiddenInput = document.getElementById(selectorId);
                if (!hiddenInput) return;
                
                // 获取相关元素
                const container = document.getElementById(`${selectorId}Container`);
                const optionsContainer = document.getElementById(`${selectorId}Options`);
                const placeholder = document.getElementById(`${selectorId}Placeholder`);
                const valueDisplay = document.getElementById(`${selectorId}Value`);
                
                if (!container || !optionsContainer || !placeholder || !valueDisplay) return;
                
                // 保存当前选中的值
                const currentValue = hiddenInput.value;
                
                // 清空选项
                optionsContainer.innerHTML = '';
                
                // 添加无分栏选项
                const noColumnOption = document.createElement('div');
                noColumnOption.style.padding = '0.5rem';
                noColumnOption.style.cursor = 'pointer';
                noColumnOption.style.transition = 'background-color 0.2s';
                noColumnOption.style.paddingLeft = '1rem';
                noColumnOption.style.borderLeft = `4px solid ${currentValue === '' ? 'var(--primary-color)' : 'transparent'}`;
                noColumnOption.onmouseenter = () => noColumnOption.style.backgroundColor = 'var(--bg-color)';
                noColumnOption.onmouseleave = () => noColumnOption.style.backgroundColor = '';
                noColumnOption.textContent = '无分栏';
                noColumnOption.onclick = () => {
                    // 更新隐藏输入框的值
                    hiddenInput.value = '';
                    // 更新显示
                    placeholder.style.display = 'inline';
                    valueDisplay.style.display = 'none';
                    valueDisplay.textContent = '';
                    // 关闭选项列表
                    optionsContainer.style.display = 'none';
                    // 更新选项列表的选中状态
                    updateColumnSelectors();
                };
                optionsContainer.appendChild(noColumnOption);
                
                // 添加分栏选项
                columns.forEach(column => {
                    const option = document.createElement('div');
                    option.style.padding = '0.5rem';
                    option.style.cursor = 'pointer';
                    option.style.transition = 'background-color 0.2s';
                    option.style.paddingLeft = '1rem';
                    option.style.borderLeft = `4px solid ${currentValue === column.id ? 'var(--primary-color)' : 'transparent'}`;
                    option.onmouseenter = () => option.style.backgroundColor = 'var(--bg-color)';
                    option.onmouseleave = () => option.style.backgroundColor = '';
                    option.textContent = column.name;
                    option.onclick = () => {
                        // 更新隐藏输入框的值
                        hiddenInput.value = column.id;
                        // 更新显示
                        placeholder.style.display = 'none';
                        valueDisplay.style.display = 'inline';
                        valueDisplay.textContent = column.name;
                        // 关闭选项列表
                        optionsContainer.style.display = 'none';
                        // 更新选项列表的选中状态
                        updateColumnSelectors();
                    };
                    optionsContainer.appendChild(option);
                });
                
                // 更新显示
                const selectedColumn = columns.find(col => col.id === currentValue);
                if (selectedColumn) {
                    placeholder.style.display = 'none';
                    valueDisplay.style.display = 'inline';
                    valueDisplay.textContent = selectedColumn.name;
                } else {
                    placeholder.style.display = 'inline';
                    valueDisplay.style.display = 'none';
                    valueDisplay.textContent = '';
                }
            });
            
            // 重新生成侧边栏的分栏菜单项
            generateSidebarColumns();
        }
        
        // 动态生成左侧主菜单中的分栏菜单项
        function generateSidebarColumns() {
            const tabList = document.querySelector('.tab-list:not(.bottom)');
            if (!tabList) return;
            
            // 找到主页面项
            const mainItem = tabList.querySelector('[data-tab="main"]');
            if (!mainItem) return;
            
            // 保存当前选中的菜单项
            const activeItem = document.querySelector('.tab-item.active');
            const currentTab = activeItem ? activeItem.dataset.tab : 'main';
            
            // 清除现有的分栏菜单项（保留主页面项）
            const existingColumns = tabList.querySelectorAll('[data-tab^="column_"]');
            existingColumns.forEach(column => column.remove());
            
            // 先获取主页面项的父节点和下一个兄弟节点
            const parentNode = mainItem.parentNode;
            let lastColumnItem = mainItem;
            
            // 直接使用columns数组的顺序，不再按order属性排序
            columns.forEach(column => {
                const menuItem = document.createElement('div');
                menuItem.className = 'tab-item';
                menuItem.dataset.tab = column.id;
                menuItem.textContent = column.name;
                
                // 添加到主菜单中，放在上一个分栏项的后面
                parentNode.insertBefore(menuItem, lastColumnItem.nextSibling);
                lastColumnItem = menuItem;
            });
            
            // 重新初始化Tab系统，确保新添加的分栏菜单项有点击事件
            initTabSystem();
            
            // 恢复当前选中的菜单项，但在排序模式下不自动点击
            const newActiveItem = document.querySelector(`[data-tab="${currentTab}"]`);
            if (newActiveItem && !activeSortListType) {
                newActiveItem.click();
            }
        }
        
        // 初始化分栏菜单
        function initColumnsMenu() {
            // 动态生成左侧主菜单中的分栏菜单项
            generateSidebarColumns();
        }
        
        // 初始化分栏选择器的下拉功能
        function initColumnSelectors() {
            // 分栏选择器的前缀列表
            const selectors = ['management-newCmdColumn', 'editCmdColumn'];
            
            selectors.forEach(selectorId => {
                const container = document.getElementById(`${selectorId}Container`);
                const optionsContainer = document.getElementById(`${selectorId}Options`);
                
                if (!container || !optionsContainer) return;
                
                // 点击容器时切换选项列表的显示状态
                container.addEventListener('click', (e) => {
                    // 阻止事件冒泡，避免触发外部的点击事件
                    e.stopPropagation();
                    
                    // 切换选项列表的显示状态
                    optionsContainer.style.display = optionsContainer.style.display === 'block' ? 'none' : 'block';
                });
            });
            
            // 点击页面其他地方时关闭所有选项列表
            document.addEventListener('click', () => {
                selectors.forEach(selectorId => {
                    const optionsContainer = document.getElementById(`${selectorId}Options`);
                    if (optionsContainer) {
                        optionsContainer.style.display = 'none';
                    }
                });
            });
        }
        
        // 初始化页面
        function init() {
            initTabSystem();
            initSearch();
            initManagementSearch();
            initTagInput();
            initColumnsMenu();
            initColumnSelectors();
            updateVariablesList();
            updateCustomTagFilter();
            updateCommands();
            updateCommandManagementList();
            updateVariableManagementList();
            updateColumnsList();
            updateColumnSelectors();
            updateColumnFilter();
            
            // 初始化文件上传事件监听
            const importFile = document.getElementById('importFile');
            const fileName = document.getElementById('fileName');
            
            importFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    fileName.textContent = e.target.files[0].name;
                } else {
                    fileName.textContent = '未选择文件';
                }
            });
        }
        
        // 初始化标签输入功能
        function initTagInput() {
            initNewCmdTagInput();
            initManagementNewCmdTagInput();
            initEditCmdTagInput();
        }
        
        // 初始化添加命令的标签输入
        function initNewCmdTagInput() {
            setupTagInput('newCmd');
        }
        
        // 初始化管理面板添加命令的标签输入
        function initManagementNewCmdTagInput() {
            setupTagInput('management-newCmd');
        }
        
        // 初始化编辑命令的标签输入
        function initEditCmdTagInput() {
            setupTagInput('editCmd');
        }
        
        // 设置标签输入功能
        function setupTagInput(prefix) {
            const container = document.getElementById(`${prefix}TagsContainer`);
            const options = document.getElementById(`${prefix}TagsOptions`);
            const placeholder = document.getElementById(`${prefix}TagsPlaceholder`);
            
            // 移除容器中所有内容
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            
            // 创建一个隐藏的输入框来存储标签数据
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = `${prefix}Tags`;
            container.appendChild(hiddenInput);
            
            // 创建一个可见的输入框，直接放在容器中
            const tagInput = document.createElement('input');
            tagInput.type = 'text';
            tagInput.id = `${prefix}TagInput`;
            tagInput.style.flex = '1';
            tagInput.style.minWidth = '100px';
            tagInput.style.fontSize = '0.9rem';
            tagInput.style.color = 'var(--text-primary)';
            tagInput.style.border = 'none';
            tagInput.style.outline = 'none';
            tagInput.style.background = 'transparent';
            tagInput.style.padding = '0.25rem 0';
            tagInput.style.margin = '0';
            tagInput.style.marginRight = '0.5rem';
            tagInput.style.placeholder = '';
            tagInput.style.boxShadow = 'none';
            tagInput.style.appearance = 'none';
            tagInput.style.borderRadius = '0';
            tagInput.style.lineHeight = '1.5';
            
            // 重置容器样式和属性
            container.contentEditable = 'false';
            container.style.cursor = 'text';
            
            // 添加占位符
            container.appendChild(placeholder);
            // 添加输入框
            container.appendChild(tagInput);
            
            let currentTags = [];
            let isDropdownOpen = false;
            let isFocused = false;
            let isComposing = false;
            
            // 更新当前标签列表
            function updateCurrentTags() {
                hiddenInput.value = currentTags.join(',');
            }
            
            // 渲染现有标签选项
            function renderTagOptions() {
                const allTags = getAllUniqueTags();
                options.innerHTML = '';
                
                if (allTags.length === 0) {
                    const noTagsMsg = document.createElement('div');
                    noTagsMsg.style.padding = '0.5rem';
                    noTagsMsg.style.color = 'var(--text-muted)';
                    noTagsMsg.style.textAlign = 'center';
                    noTagsMsg.textContent = '暂无标签，可直接输入新标签';
                    options.appendChild(noTagsMsg);
                    return;
                }
                
                allTags.forEach(tag => {
                    const option = document.createElement('div');
                    option.style.padding = '0.5rem';
                    option.style.cursor = 'pointer';
                    option.style.display = 'flex';
                    option.style.alignItems = 'center';
                    option.style.gap = '0.5rem';
                    option.style.transition = 'background-color 0.2s';
                    option.onmouseenter = () => option.style.backgroundColor = 'var(--bg-color)';
                    option.onmouseleave = () => option.style.backgroundColor = '';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = currentTags.includes(tag);
                    checkbox.style.margin = '0';
                    
                    const tagText = document.createElement('span');
                    tagText.textContent = tag;
                    tagText.style.flex = '1';
                    tagText.style.cursor = 'pointer';
                    
                    option.addEventListener('click', () => {
                        checkbox.checked = !checkbox.checked;
                        if (checkbox.checked) {
                            if (!currentTags.includes(tag)) {
                                currentTags.push(tag);
                            }
                        } else {
                            currentTags = currentTags.filter(t => t !== tag);
                        }
                        renderTags();
                        renderTagOptions();
                        updateCurrentTags();
                    });
                    
                    option.appendChild(checkbox);
                    option.appendChild(tagText);
                    options.appendChild(option);
                });
            }
            
            // 渲染标签
            function renderTags() {
                // 移除所有已有的标签元素（保留输入框和隐藏输入框）
                const elements = container.querySelectorAll(':scope > *');
                elements.forEach(el => {
                    if (el.className === 'selected-tag' || el.id === placeholder.id) {
                        el.remove();
                    }
                });
                
                // 确定是否显示占位符
                const shouldShowPlaceholder = !isFocused && currentTags.length === 0 && !tagInput.value;
                
                if (shouldShowPlaceholder) {
                    container.insertBefore(placeholder, tagInput);
                }
                
                // 添加所有标签，插入到输入框前面
                for (let i = 0; i < currentTags.length; i++) {
                    const tag = currentTags[i];
                    const tagElement = document.createElement('span');
                    tagElement.className = 'selected-tag';
                    tagElement.dataset.tag = tag;
                    
                    const tagText = document.createElement('span');
                    tagText.textContent = tag;
                    tagText.style.marginRight = '0.3rem';
                    
                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'tag-delete-btn';
                    deleteBtn.textContent = '×';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.style.fontSize = '1rem';
                    deleteBtn.style.display = 'inline-block';
                    deleteBtn.style.width = '16px';
                    deleteBtn.style.height = '16px';
                    deleteBtn.style.textAlign = 'center';
                    deleteBtn.style.lineHeight = '14px';
                    deleteBtn.style.borderRadius = '50%';
                    deleteBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    deleteBtn.style.transition = 'background-color 0.2s';
                    deleteBtn.style.userSelect = 'none';
                    
                    deleteBtn.addEventListener('mouseenter', () => {
                        deleteBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                    });
                    deleteBtn.addEventListener('mouseleave', () => {
                        deleteBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tagToRemove = tagElement.dataset.tag;
                        currentTags = currentTags.filter(t => t !== tagToRemove);
                        renderTags();
                        updateCurrentTags();
                    });
                    
                    tagElement.appendChild(tagText);
                    tagElement.appendChild(deleteBtn);
                    container.insertBefore(tagElement, tagInput);
                }
            }
            
            // 显示标签选项
            function showTagOptions() {
                renderTagOptions();
                options.style.display = 'block';
                isDropdownOpen = true;
            }
            
            // 隐藏标签选项
            function hideTagOptions() {
                options.style.display = 'none';
                isDropdownOpen = false;
            }
            
            // 添加标签
            function addTag() {
                const tagValue = tagInput.value.trim();
                if (tagValue && !currentTags.includes(tagValue)) {
                    currentTags.push(tagValue);
                    tagInput.value = '';
                    renderTags();
                    updateCurrentTags();
                    hideTagOptions();
                }
            }
            
            // 处理按键事件
            function handleKeyDown(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    addTag();
                } else if (e.key === 'Backspace') {
                    if (!tagInput.value && currentTags.length > 0) {
                        e.preventDefault();
                        currentTags.pop();
                        renderTags();
                        updateCurrentTags();
                    }
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    hideTagOptions();
                }
            }
            
            // 容器点击事件
            container.addEventListener('click', () => {
                tagInput.focus();
                if (!isDropdownOpen) {
                    showTagOptions();
                }
            });
            
            // 中文输入相关事件
            tagInput.addEventListener('compositionstart', () => {
                isComposing = true;
            });
            
            tagInput.addEventListener('compositionupdate', () => {
                // 中文输入过程中不更新标签
            });
            
            tagInput.addEventListener('compositionend', () => {
                isComposing = false;
                renderTags();
                if (!isDropdownOpen && tagInput.value.trim()) {
                    showTagOptions();
                }
            });
            
            // 输入事件
            tagInput.addEventListener('input', () => {
                if (!isComposing) {
                    renderTags();
                    if (!isDropdownOpen && tagInput.value.trim()) {
                        showTagOptions();
                    }
                }
            });
            
            // 焦点事件
            tagInput.addEventListener('focus', () => {
                isFocused = true;
                renderTags();
            });
            
            tagInput.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!container.contains(document.activeElement) && !options.contains(document.activeElement)) {
                        isFocused = false;
                        if (!tagInput.value) {
                            renderTags();
                        }
                    }
                }, 200);
            });
            
            // 点击页面其他地方关闭标签选项
            document.addEventListener('click', (e) => {
                if (!container.contains(e.target) && !options.contains(e.target)) {
                    hideTagOptions();
                }
            });
            
            // 确保选项点击不会关闭下拉框
            options.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // 添加事件监听
            tagInput.addEventListener('keydown', handleKeyDown);
            
            // 获取当前标签列表
            const camelCasePrefix = prefix.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
            const getTagsFunctionName = `get${camelCasePrefix.charAt(0).toUpperCase() + camelCasePrefix.slice(1)}Tags`;
            const setTagsFunctionName = `set${camelCasePrefix.charAt(0).toUpperCase() + camelCasePrefix.slice(1)}Tags`;
            
            window[getTagsFunctionName] = () => {
                const tagValue = tagInput.value.trim();
                if (tagValue && !currentTags.includes(tagValue)) {
                    currentTags.push(tagValue);
                    tagInput.value = '';
                    renderTags();
                    updateCurrentTags();
                }
                return currentTags;
            };
            
            window[setTagsFunctionName] = (tags) => {
                currentTags = tags;
                tagInput.value = '';
                renderTags();
                updateCurrentTags();
            };
            
            // 初始渲染
            renderTags();
        }

        // 复制命令到剪贴板
        function copyCommand(btn) {
            const pre = btn.nextElementSibling;
            const text = pre.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = '已复制';
                btn.classList.add('copied');
                
                // 显示复制成功提示
                showToast('命令已复制到剪贴板', 'success');
                
                setTimeout(() => {
                    btn.textContent = '复制';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // 编辑变量值
        function editVariable(element) {
            const currentValue = element.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.className = 'variable-value editing';
            
            // 替换当前元素为输入框
            const parent = element.parentElement;
            parent.replaceChild(input, element);
            
            // 自动聚焦
            input.focus();
            input.select();
            
            // 失去焦点时保存
            input.addEventListener('blur', () => {
                saveVariable(parent, input.value);
            });
            
            // 按下Enter键保存
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveVariable(parent, input.value);
                }
            });
        }

        // 保存变量值
        function saveVariable(parent, newValue) {
            const variableName = parent.querySelector('.variable-name').textContent;
            const div = document.createElement('div');
            div.className = 'variable-value';
            div.textContent = newValue;
            div.onclick = () => editVariable(div);
            
            parent.replaceChild(div, parent.querySelector('input'));
            
            // 更新变量存储
            variables[variableName] = newValue;
            
            // 保存数据到localStorage
            saveData();
            
            // 更新所有命令
            updateCommands();
            
            // 更新变量管理列表
            updateVariableManagementList();
        }



        // 更新所有命令 - 主页面不显示编辑和删除按钮，但显示描述和标签，支持标签筛选和搜索
        function updateCommands() {
            const commandsList = document.getElementById('commandsList');
            commandsList.innerHTML = '';
            
            // 按sortOrder排序命令
            const sortedCommands = [...commands].sort((a, b) => a.sortOrder - b.sortOrder);
            
            // 添加排序按钮
            const sortContainer = document.createElement('div');
            sortContainer.style.display = 'flex';
            sortContainer.style.justifyContent = 'flex-end';
            sortContainer.style.marginBottom = '1rem';
            
            // 根据当前排序状态设置按钮样式和文本
            const isSorting = activeSortListType === 'commands';
            const buttonStyle = isSorting ? 
                'background-color: var(--success-color);' : 
                'background-color: var(--primary-color);';
            const buttonText = isSorting ? 
                '✓ 点击退出' : 
                '☰ 拖动排序';
            
            sortContainer.innerHTML = `
                <button onclick="toggleSortMode('commands')" data-sort-type="commands" style="padding: 0.5rem 1rem; ${buttonStyle} color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                    ${buttonText}
                </button>
            `;
            commandsList.appendChild(sortContainer);
            
            sortedCommands.forEach((command, index) => {
                let showCommand = true;
                
                // 1. 分栏筛选
                if (activeColumnId) {
                    if (command.columnId !== activeColumnId) {
                        showCommand = false;
                    }
                }
                
                // 2. 标签筛选
                if (showCommand && activeTags.length > 0) {
                    const hasMatchingTag = command.tags.some(tag => activeTags.includes(tag));
                    if (!hasMatchingTag) {
                        showCommand = false;
                    }
                }
                
                // 3. 搜索筛选
                if (showCommand && searchKeyword) {
                    const searchableText = `${command.title} ${command.description} ${command.template}`.toLowerCase();
                    if (!searchableText.includes(searchKeyword)) {
                        showCommand = false;
                    }
                }
                
                // 如果不匹配，跳过
                if (!showCommand) {
                    return;
                }
                
                let commandText = command.template;
                
                // 替换所有变量 - 使用${{变量名}}格式
                // 先提取命令模板中的所有变量名，转换为大写后替换
                const matches = command.template.match(/\\$\\{\\{([A-Za-z0-9_]+)\\}\\}/g) || [];
                matches.forEach(match => {
                    // 提取变量名并转换为大写
                    const varName = match.substring(3, match.length - 2).toUpperCase();
                    // 获取变量值
                    const value = variables[varName];
                    // 如果变量值为空，使用占位符
                    const replaceValue = value || `[${varName}_PLACEHOLDER]`;
                    // 替换命令模板中的变量
                    const regex = new RegExp(`\\$\\{\\{${match.substring(3, match.length - 2)}\\}\\}`, 'g');
                    commandText = commandText.replace(regex, replaceValue);
                });
                
                let descriptionHtml = '';
                if (command.description) {
                    descriptionHtml = `<div class="command-description" style="color: var(--text-secondary); margin: 0.5rem 0;">${command.description}</div>`;
                }
                
                // 将命令按换行符分割成多个代码块
                const commandLines = commandText.split('\n').filter(line => line.trim() !== '');
                
                // 创建命令项
                const commandItem = document.createElement('div');
                commandItem.className = 'command-item';
                commandItem.dataset.listType = 'commands';
                commandItem.dataset.index = commands.indexOf(command);
                
                // 命令头和描述
                let commandHtml = `
                    <div class="command-header">
                        <h3 class="command-title">
                            <span style="cursor: move; margin-right: 0.5rem; opacity: 0.6;">☰</span>
                            ${command.title}
                        </h3>
                        <!-- 主页面不显示编辑和删除按钮 -->
                    </div>
                    ${descriptionHtml}
                    ${renderTags(command.tags)}
                `;
                
                // 为每一行命令创建一个代码块
                commandLines.forEach((line, lineIndex) => {
                    commandHtml += `
                        <div class="code-block" style="cursor: pointer; margin-top: 1rem;">
                            <button class="copy-btn" onclick="copyCommand(this)">复制</button>
                            <pre id="command${index + 1}_${lineIndex + 1}">${line}</pre>
                        </div>
                    `;
                });
                
                commandItem.innerHTML = commandHtml;
                
                // 添加点击代码块复制功能
                const codeBlocks = commandItem.querySelectorAll('.code-block');
                codeBlocks.forEach(codeBlock => {
                    codeBlock.addEventListener('click', (e) => {
                        // 如果点击的是复制按钮，不执行点击代码块的复制操作
                        if (e.target.classList.contains('copy-btn')) {
                            return;
                        }
                        
                        const pre = codeBlock.querySelector('pre');
                        const text = pre.textContent;
                        
                        navigator.clipboard.writeText(text).then(() => {
                            // 显示复制成功提示
                            showToast('命令已复制到剪贴板', 'success');
                            
                            // 暂时改变按钮文本为"已复制"
                            const copyBtn = codeBlock.querySelector('.copy-btn');
                            copyBtn.textContent = '已复制';
                            copyBtn.classList.add('copied');
                            
                            setTimeout(() => {
                                copyBtn.textContent = '复制';
                                copyBtn.classList.remove('copied');
                            }, 2000);
                        }).catch(err => {
                            console.error('复制失败:', err);
                            showToast('复制失败，请重试', 'error');
                        });
                    });
                });
                
                // 添加拖动事件监听器（如果当前处于排序模式）
                if (activeSortListType === 'commands') {
                    commandItem.draggable = true;
                    commandItem.style.cursor = 'move';
                    commandItem.addEventListener('dragstart', handleDragStart);
                    commandItem.addEventListener('dragover', handleDragOver);
                    commandItem.addEventListener('drop', handleDrop);
                    commandItem.addEventListener('dragend', handleDragEnd);
                }
                
                commandsList.appendChild(commandItem);
            });
            
            // 更新变量列表，确保只显示当前命令使用的变量
            updateVariablesList();
        }

        // 添加新变量
        function addVariable() {
            const nameInput = document.getElementById('newVarName');
            const name = nameInput.value.trim().toUpperCase();
            
            // 清除之前的错误
            nameInput.classList.remove('input-error');
            
            if (!name) {
                nameInput.classList.add('input-error');
                showToast('请输入变量名', 'error');
                return;
            }
            
            if (variables[name]) {
                nameInput.classList.add('input-error');
                showToast('变量名已存在', 'error');
                return;
            }
            
            // 添加到变量存储，使用空字符串作为默认值
            variables[name] = '';
            
            // 保存数据到localStorage
            saveData();
            
            // 更新所有相关列表
            updateVariablesList();
            updateCommands();
            updateVariableManagementList();
            
            // 清空输入框
            nameInput.value = '';
            
            // 显示成功提示
            showToast('变量添加成功', 'success');
        }
        
        // 从管理面板添加新变量
        function addManagementVariable() {
            const nameInput = document.getElementById('management-newVarName');
            const name = nameInput.value.trim().toUpperCase();
            
            // 清除之前的错误
            nameInput.classList.remove('input-error');
            
            if (!name) {
                nameInput.classList.add('input-error');
                showToast('请输入变量名', 'error');
                return;
            }
            
            if (variables[name]) {
                nameInput.classList.add('input-error');
                showToast('变量名已存在', 'error');
                return;
            }
            
            // 添加到变量存储，使用空字符串作为默认值
            variables[name] = '';
            
            // 保存数据到localStorage
            saveData();
            
            // 更新所有相关列表
            updateVariablesList();
            updateCommands();
            updateVariableManagementList();
            
            // 清空输入框
            nameInput.value = '';
            
            // 显示成功提示
            showToast('变量添加成功', 'success');
        }

        // 删除变量
        function deleteVariable(name) {
            // 转换为大写
            const upperCaseName = name.toUpperCase();
            showConfirmModal(
                '确认删除变量',
                `确定要删除变量 ${upperCaseName} 吗？`,
                () => {
                    delete variables[upperCaseName];
                    
                    // 保存数据到localStorage
                    saveData();
                    
                    // 更新所有相关列表
                    updateVariablesList();
                    updateCommands();
                    updateVariableManagementList();
                    
                    // 显示成功提示
                    showToast('变量删除成功', 'success');
                }
            );
        }

        // 解析标签字符串为数组
        function parseTags(tagsString) {
            return tagsString
                .split(',')
                .map(tag => tag.trim())
                .filter(tag => tag.length > 0);
        }

        // 添加新命令 - 自动添加新变量
        function addCommand() {
            const titleInput = document.getElementById('newCmdTitle');
            const descriptionInput = document.getElementById('newCmdDescription');
            const templateInput = document.getElementById('newCmdTemplate');
            
            const title = titleInput.value.trim();
            const description = descriptionInput.value.trim();
            const tags = getNewCmdTags();
            const template = templateInput.value.trim();
            
            // 清除之前的错误
            titleInput.classList.remove('input-error');
            templateInput.classList.remove('input-error');
            
            if (!title) {
                titleInput.classList.add('input-error');
                showToast('请输入命令标题', 'error');
                return;
            }
            
            if (!template) {
                templateInput.classList.add('input-error');
                showToast('请输入命令模板', 'error');
                return;
            }
            
            // 自动添加命令中的新变量
            const hasNewVariable = autoAddVariablesFromCommand(template);
            
            // 添加到命令存储
            commands.push({
                title: title,
                description: description,
                tags: tags,
                template: template,
                columnId: null,
                sortOrder: commands.length
            });
            
            // 保存数据到localStorage
            saveData();
            
            // 更新所有相关列表
            updateCustomTagFilter(); // 新命令可能包含新标签
            updateCommands();
            updateVariablesList(); // 新命令可能包含新变量
            updateCommandManagementList();
            updateVariableManagementList(); // 如果有新变量，更新变量管理列表
            
            // 清空输入框
            titleInput.value = '';
            descriptionInput.value = '';
            templateInput.value = '';
            
            // 显示成功提示
            let message = '命令添加成功';
            if (hasNewVariable) {
                message += '，已自动添加新变量';
            }
            showToast(message, 'success');
        }
        
        // 从管理面板添加新命令
        function addManagementCommand() {
            const titleInput = document.getElementById('management-newCmdTitle');
            const descriptionInput = document.getElementById('management-newCmdDescription');
            const templateInput = document.getElementById('management-newCmdTemplate');
            const columnSelect = document.getElementById('management-newCmdColumn');
            
            const title = titleInput.value.trim();
            const description = descriptionInput.value.trim();
            const tags = window['getManagementNewCmdTags'] ? window['getManagementNewCmdTags']() : [];
            const template = templateInput.value.trim();
            const columnId = columnSelect ? columnSelect.value : '';
            
            // 清除之前的错误
            titleInput.classList.remove('input-error');
            templateInput.classList.remove('input-error');
            
            if (!title) {
                titleInput.classList.add('input-error');
                showToast('请输入命令标题', 'error');
                return;
            }
            
            if (!template) {
                templateInput.classList.add('input-error');
                showToast('请输入命令模板', 'error');
                return;
            }
            
            // 自动添加命令中的新变量
            const hasNewVariable = autoAddVariablesFromCommand(template);
            
            // 添加到命令存储
            commands.push({
                title: title,
                description: description,
                tags: tags,
                template: template,
                columnId: columnId || null,
                sortOrder: commands.length
            });
            
            // 保存数据到localStorage
            saveData();
            
            // 更新所有相关列表
            updateCustomTagFilter(); // 新命令可能包含新标签
            updateCommands();
            updateVariablesList(); // 新命令可能包含新变量
            updateCommandManagementList();
            updateVariableManagementList(); // 如果有新变量，更新变量管理列表
            
            // 清空输入框
            titleInput.value = '';
            descriptionInput.value = '';
            templateInput.value = '';
            if (columnSelect) {
                columnSelect.value = '';
            }
            
            // 显示成功提示
            let message = '命令添加成功';
            if (hasNewVariable) {
                message += '，已自动添加新变量';
            }
            showToast(message, 'success');
        }

        // 删除命令
        function deleteCommand(index) {
            showConfirmModal(
                '确认删除命令',
                `确定要删除命令 "${commands[index].title}" 吗？`,
                () => {
                    commands.splice(index, 1);
                    
                    // 保存数据到localStorage
                    saveData();
                    
                    // 更新所有相关列表
                    updateCustomTagFilter(); // 删除命令可能移除标签
                    updateCommands();
                    updateVariablesList(); // 删除命令可能减少变量
                    updateCommandManagementList();
                    
                    // 显示成功提示
                    showToast('命令删除成功', 'success');
                }
            );
        }

        // 打开编辑命令模态框
        function openEditModal(index) {
            currentEditIndex = index;
            const command = commands[index];
            
            document.getElementById('editCmdTitle').value = command.title;
            document.getElementById('editCmdDescription').value = command.description || '';
            setEditCmdTags(command.tags || []);
            document.getElementById('editCmdTemplate').value = command.template;
            document.getElementById('editCmdColumn').value = command.columnId || '';
            // 更新分栏选择器的UI显示
            updateColumnSelectors();
            document.getElementById('editModal').classList.add('show');
        }

        // 关闭编辑命令模态框
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEditIndex = -1;
        }

        // 保存编辑后的命令 - 自动添加新变量
        function saveEditedCommand() {
            if (currentEditIndex === -1) return;
            
            const titleInput = document.getElementById('editCmdTitle');
            const descriptionInput = document.getElementById('editCmdDescription');
            const templateInput = document.getElementById('editCmdTemplate');
            const columnSelect = document.getElementById('editCmdColumn');
            
            const title = titleInput.value.trim();
            const description = descriptionInput.value.trim();
            const tags = getEditCmdTags();
            const template = templateInput.value.trim();
            const columnId = columnSelect.value || null;
            
            // 清除之前的错误
            titleInput.classList.remove('input-error');
            templateInput.classList.remove('input-error');
            document.getElementById('editCmdTitleError').textContent = '';
            document.getElementById('editCmdTemplateError').textContent = '';
            
            let hasError = false;
            
            if (!title) {
                titleInput.classList.add('input-error');
                document.getElementById('editCmdTitleError').textContent = '请输入命令标题';
                hasError = true;
            }
            
            if (!template) {
                templateInput.classList.add('input-error');
                document.getElementById('editCmdTemplateError').textContent = '请输入命令模板';
                hasError = true;
            }
            
            if (hasError) {
                return;
            }
            
            // 自动添加命令中的新变量
            const hasNewVariable = autoAddVariablesFromCommand(template);
            
            // 更新命令
            commands[currentEditIndex] = {
                title: title,
                description: description,
                tags: tags,
                template: template,
                columnId: columnId
            };
            
            // 保存数据到localStorage
            saveData();
            
            // 更新所有相关列表
            updateCustomTagFilter(); // 编辑命令可能修改标签
            updateCommands();
            updateVariablesList(); // 编辑命令可能改变变量
            updateCommandManagementList();
            updateVariableManagementList(); // 如果有新变量，更新变量管理列表
            
            // 显示成功提示
            let message = '命令编辑成功';
            if (hasNewVariable) {
                message += '，已自动添加新变量';
            }
            showToast(message, 'success');
            
            // 关闭模态框
            closeEditModal();
        }

        // 数据导出功能
        function exportData() {
            const data = {
                variables: variables,
                commands: commands,
                columns: columns,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `command-generator-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showToast('数据导出成功', 'success');
        }

        // 数据导入功能
        function importData() {
            const fileInput = document.getElementById('importFile');
            const importType = document.querySelector('input[name="importType"]:checked').value;
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('请选择要导入的JSON文件', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    if (!importedData.variables || !importedData.commands) {
                        throw new Error('无效的数据格式：缺少变量或命令数据');
                    }
                    
                    if (importType === 'full') {
                        // 全新导入：覆盖现有数据
                        variables = importedData.variables;
                        commands = importedData.commands;
                        // 导入分栏数据（如果存在）
                        columns = importedData.columns || [];
                        showToast('数据全新导入成功', 'success');
                    } else {
                        // 增量导入：合并现有数据
                        // 合并变量：新变量覆盖旧变量
                        variables = { ...variables, ...importedData.variables };
                        
                        // 合并命令：避免重复，使用标题作为唯一标识
                        const existingTitles = new Set(commands.map(cmd => cmd.title));
                        const newCommands = importedData.commands.filter(cmd => !existingTitles.has(cmd.title));
                        commands = [...commands, ...newCommands];
                        
                        // 合并分栏数据：避免重复，使用ID作为唯一标识
                        if (importedData.columns) {
                            const existingColumnIds = new Set(columns.map(col => col.id));
                            const newColumns = importedData.columns.filter(col => !existingColumnIds.has(col.id));
                            columns = [...columns, ...newColumns];
                        }
                        
                        showToast(`数据增量导入成功，新增${newCommands.length}条命令`, 'success');
                    }
                    
                    // 保存数据到localStorage
                    saveData();
                    
                    // 重新初始化页面
                    init();
                    
                    // 清空文件输入
                    fileInput.value = '';
                    
                } catch (error) {
                    showToast(`数据导入失败：${error.message}`, 'error');
                }
            };
            
            reader.onerror = () => {
                showToast('文件读取失败', 'error');
            };
            
            reader.readAsText(file);
        }

        // 清除所有数据功能
        function clearAllData() {
            showConfirmModal(
                '警告：删除所有数据',
                '此操作将永久删除所有数据，包括所有命令、变量和分栏！\n\n您确定要继续吗？',
                () => {
                    // 第二次确认
                    showConfirmModal(
                        '再次确认删除',
                        '请再次确认：此操作不可恢复，所有数据将被永久删除！',
                        () => {
                            // 清除所有数据
                            variables = {};
                            commands = [];
                            columns = [];
                            
                            // 清空localStorage
                            localStorage.removeItem('commandGeneratorVariables');
                            localStorage.removeItem('commandGeneratorCommands');
                            localStorage.removeItem('commandGeneratorColumns');
                            // 设置清除数据标志
                            localStorage.setItem('commandGeneratorHasClearedData', 'true');
                            
                            // 重新初始化页面
                            init();
                            
                            showToast('所有数据已清除', 'success');
                        }
                    );
                }
            );
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            const confirmModal = document.getElementById('confirmModal');
            
            if (event.target === modal) {
                closeEditModal();
            }
            
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
        }

        // 初始化
        init();
    </script>
</body>
</html>